# 将不安全代码封装在小型模块中

## 描述

如果你有 `unsafe` 代码，应创建一个尽可能小的模块来维护必要的不变性，并在此基础上构建一个最小的安全接口。然后将这个模块嵌入到一个更大的、仅包含安全代码的模块中，并提供一个符合人体工程学的接口。注意，外部模块可以包含直接调用不安全代码的 unsafe 函数和方法。用户可以使用这些方法来获得性能优势。

## 优点

- 这限制了需要审计的不安全代码的范围
- 编写外部模块变得更加容易，因为你可以依赖内部模块提供的保证

## 缺点

- 有时可能很难找到合适的接口
- 抽象可能会引入性能开销

## 示例

- [`toolshed`](https://docs.rs/toolshed) crate 将其不安全操作封装在子模块中，向用户提供安全的接口
- `std` 中的 `String` 类是 `Vec<u8>` 的包装器，并添加了内容必须是有效 UTF-8 的不变性约束。`String` 的操作确保了这种行为。然而，用户可以选择使用 `unsafe` 方法来创建 `String`，在这种情况下，确保内容有效性的责任就落在了用户身上。

## 参见

- [Ralf Jung 关于不安全代码中不变性的博客](https://www.ralfj.de/blog/2018/08/22/two-kinds-of-invariants.html)
